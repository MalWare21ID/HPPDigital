<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator HPP & Resep</title>
    <!-- Tailwind CSS Play CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel for JSX Browser Support -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background-color: white !important; padding: 0 !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // Custom Icon Component to handle Lucide in CDN env
        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size }}></i>;
        };

        const App = () => {
            const [recipeName, setRecipeName] = useState('Resep Baru');
            const [portions, setPortions] = useState(1);
            const [ingredients, setIngredients] = useState([
                { id: 1, name: 'Tepung Terigu', bulkQty: 1000, bulkUnit: 'gr', bulkPrice: 15000, usedQty: 250, usedUnit: 'gr' }
            ]);
            const [overhead, setOverhead] = useState({
                packaging: 0,
                labor: 0,
                other: 0
            });
            const [targetMargin, setTargetMargin] = useState(30);

            const units = ['gr', 'kg', 'ml', 'L', 'pcs', 'butir', 'sdm', 'sdt'];

            const addIngredient = () => {
                const newId = ingredients.length > 0 ? Math.max(...ingredients.map(i => i.id)) + 1 : 1;
                setIngredients([...ingredients, { 
                    id: newId, name: '', bulkQty: 1000, bulkUnit: 'gr', bulkPrice: 0, usedQty: 0, usedUnit: 'gr' 
                }]);
            };

            const removeIngredient = (id) => {
                setIngredients(ingredients.filter(i => i.id !== id));
            };

            const updateIngredient = (id, field, value) => {
                setIngredients(ingredients.map(i => 
                    i.id === id ? { ...i, [field]: value } : i
                ));
            };

            const calculateIngredientCost = (ing) => {
                if (!ing.bulkQty || !ing.bulkPrice || !ing.usedQty) return 0;
                let normalizedBulkQty = ing.bulkQty;
                let normalizedUsedQty = ing.usedQty;
                if (ing.bulkUnit === 'kg' || ing.bulkUnit === 'L') normalizedBulkQty *= 1000;
                if (ing.usedUnit === 'kg' || ing.usedUnit === 'L') normalizedUsedQty *= 1000;
                return (normalizedUsedQty / normalizedBulkQty) * ing.bulkPrice;
            };

            const totals = useMemo(() => {
                const totalIngredientsCost = ingredients.reduce((sum, ing) => sum + calculateIngredientCost(ing), 0);
                const totalOverhead = Number(overhead.packaging) + Number(overhead.labor) + Number(overhead.other);
                const totalProductionCost = totalIngredientsCost + (totalOverhead * portions);
                const costPerPortion = totalProductionCost / (portions || 1);
                const recommendedPrice = costPerPortion / (1 - (targetMargin / 100));
                
                return {
                    ingredients: totalIngredientsCost,
                    overhead: totalOverhead * portions,
                    production: totalProductionCost,
                    perPortion: costPerPortion,
                    recommended: recommendedPrice,
                    profitPerPortion: recommendedPrice - costPerPortion
                };
            }, [ingredients, portions, overhead, targetMargin]);

            const formatIDR = (val) => {
                return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(val);
            };

            return (
                <div className="min-h-screen p-4 md:p-8">
                    <div className="max-w-6xl mx-auto">
                        
                        {/* Header */}
                        <header className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4 no-print">
                            <div>
                                <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-2">
                                    <Icon name="calculator" className="text-orange-600" size={32} /> Recipe Costing
                                </h1>
                                <p className="text-gray-500">Hitung HPP dan harga jual kuliner Anda.</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => window.print()} className="flex items-center gap-2 px-4 py-2 bg-gray-900 text-white rounded-lg hover:bg-black transition font-medium">
                                    <Icon name="printer" size={16} /> Cetak
                                </button>
                                <button onClick={() => window.confirm('Hapus data?') && window.location.reload()} className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded-lg hover:bg-gray-50 transition text-sm">
                                    <Icon name="refresh-ccw" size={16} /> Reset
                                </button>
                            </div>
                        </header>

                        {/* Print Header */}
                        <div className="hidden print:block border-b-2 border-gray-900 pb-4 mb-8">
                            <h1 className="text-2xl font-bold uppercase">Laporan Analisis Biaya Resep</h1>
                            <div className="mt-2 text-sm flex justify-between">
                                <span>Dicetak: {new Date().toLocaleDateString('id-ID', {dateStyle: 'full'})}</span>
                                <span className="font-bold">{recipeName}</span>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 print:block">
                            
                            <div className="lg:col-span-2 space-y-6">
                                {/* Basic Info */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print:p-0 print:shadow-none print:border-none">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 uppercase">Nama Resep</label>
                                            <input type="text" value={recipeName} onChange={e => setRecipeName(e.target.value)} className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg no-print" />
                                            <p className="hidden print:block text-xl font-bold">{recipeName}</p>
                                        </div>
                                        <div>
                                            <label className="text-xs font-bold text-gray-400 uppercase">Jumlah Porsi</label>
                                            <input type="number" value={portions} onChange={e => setPortions(Number(e.target.value))} className="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg no-print" />
                                            <p className="hidden print:block text-xl font-bold">{portions} Porsi</p>
                                        </div>
                                    </div>
                                </div>

                                {/* Ingredients */}
                                <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden print:rounded-none print:border-gray-200">
                                    <div className="p-4 border-b flex justify-between items-center bg-gray-50 no-print">
                                        <h2 className="font-bold">Daftar Bahan</h2>
                                        <button onClick={addIngredient} className="bg-orange-600 text-white px-3 py-1 rounded-lg text-sm font-bold">+ Tambah</button>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left">
                                            <thead className="bg-gray-50 text-[10px] font-bold uppercase text-gray-500 print:bg-gray-100 print:text-black">
                                                <tr>
                                                    <th className="p-4">Bahan</th>
                                                    <th className="p-4">Harga Grosir</th>
                                                    <th className="p-4">Digunakan</th>
                                                    <th className="p-4">Subtotal</th>
                                                    <th className="p-4 no-print"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {ingredients.map(ing => (
                                                    <tr key={ing.id} className="text-sm">
                                                        <td className="p-4">
                                                            <input type="text" value={ing.name} onChange={e => updateIngredient(ing.id, 'name', e.target.value)} className="w-full bg-transparent no-print outline-none border-b border-transparent focus:border-orange-500" placeholder="Nama bahan..." />
                                                            <span className="hidden print:block font-medium">{ing.name || 'Tanpa Nama'}</span>
                                                        </td>
                                                        <td className="p-4">
                                                            <div className="flex flex-col no-print">
                                                                <div className="flex gap-1 items-center">
                                                                    <input type="number" value={ing.bulkQty} onChange={e => updateIngredient(ing.id, 'bulkQty', e.target.value)} className="w-12 bg-gray-100 p-1 rounded" />
                                                                    <select value={ing.bulkUnit} onChange={e => updateIngredient(ing.id, 'bulkUnit', e.target.value)} className="bg-transparent text-xs">{units.map(u => <option key={u}>{u}</option>)}</select>
                                                                </div>
                                                                <span className="text-[10px] text-gray-400">Rp <input type="number" value={ing.bulkPrice} onChange={e => updateIngredient(ing.id, 'bulkPrice', e.target.value)} className="w-16 bg-transparent" /></span>
                                                            </div>
                                                            <span className="hidden print:block text-xs">{ing.bulkQty} {ing.bulkUnit} @ {formatIDR(ing.bulkPrice)}</span>
                                                        </td>
                                                        <td className="p-4">
                                                            <div className="flex gap-1 items-center no-print">
                                                                <input type="number" value={ing.usedQty} onChange={e => updateIngredient(ing.id, 'usedQty', e.target.value)} className="w-12 bg-orange-50 p-1 rounded border border-orange-100" />
                                                                <select value={ing.usedUnit} onChange={e => updateIngredient(ing.id, 'usedUnit', e.target.value)} className="bg-transparent text-xs">{units.map(u => <option key={u}>{u}</option>)}</select>
                                                            </div>
                                                            <span className="hidden print:block">{ing.usedQty} {ing.usedUnit}</span>
                                                        </td>
                                                        <td className="p-4 font-bold">{formatIDR(calculateIngredientCost(ing))}</td>
                                                        <td className="p-4 no-print text-right">
                                                            <button onClick={() => removeIngredient(ing.id)} className="text-gray-300 hover:text-red-500"><Icon name="trash-2" size={16} /></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="p-4 bg-gray-50 text-right print:bg-white border-t">
                                        <span className="text-xs font-bold uppercase text-gray-400 mr-4">Total Bahan:</span>
                                        <span className="text-lg font-bold">{formatIDR(totals.ingredients)}</span>
                                    </div>
                                </div>

                                {/* Overhead */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-100 print:rounded-none print:border-gray-200">
                                    <h2 className="font-bold mb-4 flex items-center gap-2"><Icon name="package" className="text-orange-600 no-print" /> Biaya Operasional / Porsi</h2>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        {['packaging', 'labor', 'other'].map(key => (
                                            <div key={key} className="bg-gray-50 p-3 rounded-xl print:bg-white print:p-0">
                                                <label className="block text-[10px] font-bold text-gray-400 uppercase mb-1">{key === 'packaging' ? 'Kemasan' : key === 'labor' ? 'Tenaga Kerja' : 'Utilitas/Lainnya'}</label>
                                                <input type="number" value={overhead[key]} onChange={e => setOverhead({...overhead, [key]: e.target.value})} className="w-full bg-white border border-gray-200 rounded p-1 no-print" />
                                                <p className="hidden print:block font-bold">{formatIDR(overhead[key])}</p>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Sidebar Analysis */}
                            <div className="print:mt-8">
                                <div className="bg-gray-900 text-white p-6 rounded-3xl shadow-xl sticky top-8 print:bg-white print:text-black print:rounded-none print:border-2 print:border-black print:shadow-none">
                                    <h2 className="text-xl font-bold mb-6 border-b border-gray-800 pb-2 print:border-black">Analisis Laba</h2>
                                    
                                    <div className="space-y-4 mb-8">
                                        <div className="flex justify-between text-sm text-gray-400 print:text-gray-600">
                                            <span>Modal Total Produksi</span>
                                            <span className="font-bold text-white print:text-black">{formatIDR(totals.production)}</span>
                                        </div>
                                        <div className="flex justify-between items-center bg-orange-600/10 p-4 rounded-2xl text-orange-400 print:bg-gray-100 print:text-black print:rounded-none">
                                            <span className="text-xs font-bold uppercase">Modal / Porsi (HPP)</span>
                                            <span className="text-2xl font-black">{formatIDR(totals.perPortion)}</span>
                                        </div>
                                    </div>

                                    <div className="mb-6 no-print">
                                        <div className="flex justify-between text-xs font-bold mb-2">
                                            <span className="uppercase text-gray-400">Target Margin</span>
                                            <span className="text-orange-400">{targetMargin}%</span>
                                        </div>
                                        <input type="range" min="5" max="85" step="5" value={targetMargin} onChange={e => setTargetMargin(Number(e.target.value))} className="w-full h-2 bg-gray-800 rounded-lg appearance-none accent-orange-500" />
                                    </div>

                                    <div className="bg-white/5 p-6 rounded-2xl border border-white/10 text-center print:bg-gray-900 print:text-white print:rounded-none">
                                        <p className="text-[10px] uppercase font-bold text-gray-400 mb-1">Rekomendasi Harga Jual</p>
                                        <p className="text-3xl font-black">{formatIDR(totals.recommended)}</p>
                                    </div>

                                    <div className="mt-4 flex items-center gap-2 text-xs text-emerald-400 bg-emerald-400/5 p-3 rounded-xl print:text-black print:bg-emerald-50">
                                        <Icon name="info" size={14} />
                                        <span>Potensi laba: <b>{formatIDR(totals.profitPerPortion)}</b> per porsi.</span>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
