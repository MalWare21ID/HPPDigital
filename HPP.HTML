import React, { useState, useMemo } from 'react';
import { Plus, Trash2, Calculator, Utensils, DollarSign, Percent, Package, Info, RefreshCcw, Printer } from 'lucide-react';

const App = () => {
  const [recipeName, setRecipeName] = useState('Resep Baru');
  const [portions, setPortions] = useState(1);
  const [ingredients, setIngredients] = useState([
    { id: 1, name: 'Tepung Terigu', bulkQty: 1000, bulkUnit: 'gr', bulkPrice: 15000, usedQty: 250, usedUnit: 'gr' }
  ]);
  const [overhead, setOverhead] = useState({
    packaging: 0,
    labor: 0,
    other: 0
  });
  const [targetMargin, setTargetMargin] = useState(30);

  const units = ['gr', 'kg', 'ml', 'L', 'pcs', 'butir', 'sdm', 'sdt'];

  const addIngredient = () => {
    const newId = ingredients.length > 0 ? Math.max(...ingredients.map(i => i.id)) + 1 : 1;
    setIngredients([...ingredients, { 
      id: newId, 
      name: '', 
      bulkQty: 1000, 
      bulkUnit: 'gr', 
      bulkPrice: 0, 
      usedQty: 0, 
      usedUnit: 'gr' 
    }]);
  };

  const removeIngredient = (id) => {
    setIngredients(ingredients.filter(i => i.id !== id));
  };

  const updateIngredient = (id, field, value) => {
    setIngredients(ingredients.map(i => 
      i.id === id ? { ...i, [field]: value } : i
    ));
  };

  const calculateIngredientCost = (ing) => {
    if (!ing.bulkQty || !ing.bulkPrice || !ing.usedQty) return 0;
    
    let normalizedBulkQty = ing.bulkQty;
    let normalizedUsedQty = ing.usedQty;

    if (ing.bulkUnit === 'kg') normalizedBulkQty *= 1000;
    if (ing.usedUnit === 'kg') normalizedUsedQty *= 1000;
    if (ing.bulkUnit === 'L') normalizedBulkQty *= 1000;
    if (ing.usedUnit === 'L') normalizedUsedQty *= 1000;

    return (normalizedUsedQty / normalizedBulkQty) * ing.bulkPrice;
  };

  const totals = useMemo(() => {
    const totalIngredientsCost = ingredients.reduce((sum, ing) => sum + calculateIngredientCost(ing), 0);
    const totalOverhead = Number(overhead.packaging) + Number(overhead.labor) + Number(overhead.other);
    const totalProductionCost = totalIngredientsCost + (totalOverhead * portions);
    const costPerPortion = totalProductionCost / (portions || 1);
    const recommendedPrice = costPerPortion / (1 - (targetMargin / 100));
    
    return {
      ingredients: totalIngredientsCost,
      overhead: totalOverhead * portions,
      production: totalProductionCost,
      perPortion: costPerPortion,
      recommended: recommendedPrice,
      profitPerPortion: recommendedPrice - costPerPortion
    };
  }, [ingredients, portions, overhead, targetMargin]);

  const resetAll = () => {
    if(window.confirm('Hapus semua data resep?')) {
      setIngredients([]);
      setPortions(1);
      setOverhead({ packaging: 0, labor: 0, other: 0 });
    }
  };

  const handlePrint = () => {
    window.print();
  };

  const formatIDR = (val) => {
    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(val);
  };

  return (
    <div className="min-h-screen bg-slate-50 p-4 md:p-8 font-sans text-slate-800 print:bg-white print:p-0">
      <div className="max-w-6xl mx-auto">
        
        {/* Header - Hidden on Print */}
        <header className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4 print:hidden">
          <div>
            <h1 className="text-3xl font-bold text-slate-900 flex items-center gap-2">
              <Calculator className="text-orange-500" /> Recipe Costing
            </h1>
            <p className="text-slate-500">Hitung modal dan tentukan harga jual dengan presisi.</p>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={handlePrint}
              className="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition shadow-md text-sm font-medium"
            >
              <Printer size={16} /> Cetak Laporan
            </button>
            <button 
              onClick={resetAll}
              className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-lg hover:bg-slate-50 transition shadow-sm text-sm"
            >
              <RefreshCcw size={16} /> Reset
            </button>
          </div>
        </header>

        {/* Print Only Header */}
        <div className="hidden print:block mb-8 border-b-2 border-slate-900 pb-4">
          <h1 className="text-2xl font-bold uppercase tracking-tight">Laporan Analisis Biaya Resep</h1>
          <div className="mt-2 text-sm text-slate-600 flex justify-between">
            <span>Dicetak pada: {new Date().toLocaleDateString('id-ID', { dateStyle: 'long' })}</span>
            <span className="font-bold text-slate-900">{recipeName}</span>
          </div>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 print:block">
          
          <div className="lg:col-span-2 space-y-6 print:w-full">
            
            {/* Recipe Meta */}
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 print:shadow-none print:border-none print:p-0 print:mb-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 print:grid-cols-2">
                <div>
                  <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Nama Resep</label>
                  <p className="hidden print:block text-xl font-bold text-slate-900">{recipeName}</p>
                  <input 
                    type="text" 
                    value={recipeName}
                    onChange={(e) => setRecipeName(e.target.value)}
                    className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition print:hidden"
                    placeholder="Contoh: Brownies Panggang"
                  />
                </div>
                <div>
                  <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Jumlah Porsi (Yield)</label>
                  <p className="hidden print:block text-xl font-bold text-slate-900">{portions} Porsi</p>
                  <div className="relative print:hidden">
                    <Utensils className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18} />
                    <input 
                      type="number" 
                      value={portions}
                      onChange={(e) => setPortions(Math.max(1, parseInt(e.target.value) || 0))}
                      className="w-full p-3 pl-10 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none transition"
                    />
                  </div>
                </div>
              </div>
            </div>

            {/* Ingredients List */}
            <div className="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden print:shadow-none print:border-slate-200 print:rounded-none">
              <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10 print:static print:p-2">
                <h2 className="font-bold text-lg flex items-center gap-2">
                  <Package size={20} className="text-orange-500 print:text-black" /> Daftar Bahan Baku
                </h2>
                <button 
                  onClick={addIngredient}
                  className="flex items-center gap-2 bg-orange-500 text-white px-4 py-2 rounded-xl hover:bg-orange-600 transition shadow-md shadow-orange-100 font-medium text-sm print:hidden"
                >
                  <Plus size={18} /> Tambah Bahan
                </button>
              </div>

              <div className="overflow-x-auto">
                <table className="w-full text-left border-collapse">
                  <thead>
                    <tr className="bg-slate-50 text-slate-500 text-[10px] uppercase tracking-wider font-bold print:bg-slate-100 print:text-slate-900">
                      <th className="p-4 w-1/4">Nama Bahan</th>
                      <th className="p-4">Pembelian (Grosir)</th>
                      <th className="p-4">Digunakan</th>
                      <th className="p-4">Subtotal</th>
                      <th className="p-4 w-10 print:hidden"></th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-slate-100 print:divide-slate-200">
                    {ingredients.map((ing) => (
                      <tr key={ing.id} className="hover:bg-slate-50/50 transition">
                        <td className="p-4">
                          <span className="hidden print:inline text-sm">{ing.name || '-'}</span>
                          <input 
                            type="text" 
                            placeholder="Contoh: Telur"
                            className="w-full bg-transparent border-b border-transparent focus:border-orange-500 outline-none py-1 print:hidden"
                            value={ing.name}
                            onChange={(e) => updateIngredient(ing.id, 'name', e.target.value)}
                          />
                        </td>
                        <td className="p-4">
                          <div className="flex flex-col gap-1">
                            <span className="hidden print:inline text-xs">{ing.bulkQty} {ing.bulkUnit} @ {formatIDR(ing.bulkPrice)}</span>
                            <div className="flex gap-1 items-center print:hidden">
                              <input 
                                type="number" 
                                className="w-16 bg-slate-100 rounded p-1 text-sm outline-none"
                                value={ing.bulkQty}
                                onChange={(e) => updateIngredient(ing.id, 'bulkQty', parseFloat(e.target.value))}
                              />
                              <select 
                                className="bg-transparent text-xs font-semibold text-slate-500 outline-none"
                                value={ing.bulkUnit}
                                onChange={(e) => updateIngredient(ing.id, 'bulkUnit', e.target.value)}
                              >
                                {units.map(u => <option key={u} value={u}>{u}</option>)}
                              </select>
                            </div>
                            <div className="flex items-center text-xs text-slate-400 print:hidden">
                              <span className="mr-1">Rp</span>
                              <input 
                                type="number"
                                className="w-20 bg-slate-100 rounded p-1 text-sm outline-none text-slate-700"
                                value={ing.bulkPrice}
                                onChange={(e) => updateIngredient(ing.id, 'bulkPrice', parseFloat(e.target.value))}
                              />
                            </div>
                          </div>
                        </td>
                        <td className="p-4">
                          <span className="hidden print:inline text-sm">{ing.usedQty} {ing.usedUnit}</span>
                          <div className="flex gap-1 items-center print:hidden">
                            <input 
                              type="number" 
                              className="w-16 bg-orange-50 border border-orange-100 rounded p-1 text-sm outline-none"
                              value={ing.usedQty}
                              onChange={(e) => updateIngredient(ing.id, 'usedQty', parseFloat(e.target.value))}
                            />
                             <select 
                                className="bg-transparent text-xs font-semibold text-slate-500 outline-none"
                                value={ing.usedUnit}
                                onChange={(e) => updateIngredient(ing.id, 'usedUnit', e.target.value)}
                              >
                                {units.map(u => <option key={u} value={u}>{u}</option>)}
                              </select>
                          </div>
                        </td>
                        <td className="p-4 font-semibold text-sm">
                          {formatIDR(calculateIngredientCost(ing))}
                        </td>
                        <td className="p-4 print:hidden">
                          <button 
                            onClick={() => removeIngredient(ing.id)}
                            className="text-slate-300 hover:text-red-500 transition"
                          >
                            <Trash2 size={18} />
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
              <div className="p-4 bg-slate-50 text-right print:bg-white print:border-t">
                <span className="text-xs font-bold text-slate-500 uppercase mr-4">Total Biaya Bahan:</span>
                <span className="text-lg font-bold">{formatIDR(totals.ingredients)}</span>
              </div>
            </div>

            {/* Overhead Costs */}
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 print:shadow-none print:border-slate-200 print:rounded-none">
              <h2 className="font-bold text-lg mb-4 flex items-center gap-2">
                <Package size={20} className="text-orange-500 print:text-black" /> Biaya Operasional & Kemasan
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 print:grid-cols-3">
                <div className="bg-slate-50 p-3 rounded-xl print:bg-transparent print:p-0">
                  <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Kemasan / Porsi</label>
                  <p className="hidden print:block font-bold">{formatIDR(overhead.packaging)}</p>
                  <div className="relative print:hidden">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">Rp</span>
                    <input 
                      type="number" 
                      value={overhead.packaging}
                      onChange={(e) => setOverhead({...overhead, packaging: e.target.value})}
                      className="w-full p-3 pl-10 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none"
                    />
                  </div>
                </div>
                <div className="bg-slate-50 p-3 rounded-xl print:bg-transparent print:p-0">
                  <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Tenaga Kerja / Porsi</label>
                  <p className="hidden print:block font-bold">{formatIDR(overhead.labor)}</p>
                  <div className="relative print:hidden">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">Rp</span>
                    <input 
                      type="number" 
                      value={overhead.labor}
                      onChange={(e) => setOverhead({...overhead, labor: e.target.value})}
                      className="w-full p-3 pl-10 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none"
                    />
                  </div>
                </div>
                <div className="bg-slate-50 p-3 rounded-xl print:bg-transparent print:p-0">
                  <label className="block text-xs font-semibold text-slate-500 uppercase mb-1">Gas & Listrik / Porsi</label>
                  <p className="hidden print:block font-bold">{formatIDR(overhead.other)}</p>
                  <div className="relative print:hidden">
                    <span className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm">Rp</span>
                    <input 
                      type="number" 
                      value={overhead.other}
                      onChange={(e) => setOverhead({...overhead, other: e.target.value})}
                      className="w-full p-3 pl-10 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500 outline-none"
                    />
                  </div>
                </div>
              </div>
            </div>

          </div>

          {/* Sidebar - Recommendations */}
          <div className="space-y-6 print:mt-8 print:w-full">
            
            {/* Summary Card */}
            <div className="bg-slate-900 text-white p-6 rounded-3xl shadow-xl sticky top-8 print:relative print:top-0 print:bg-white print:text-slate-900 print:shadow-none print:border-2 print:border-slate-900 print:rounded-none">
              <h2 className="text-xl font-bold mb-6 flex items-center gap-2 print:border-b print:pb-2">
                <DollarSign className="text-orange-400 print:text-slate-900" /> Analisis Profit
              </h2>
              
              <div className="space-y-4 mb-8">
                <div className="flex justify-between text-slate-400 text-sm print:text-slate-600">
                  <span>Modal Produksi (Total)</span>
                  <span className="text-white font-medium print:text-slate-900">{formatIDR(totals.production)}</span>
                </div>
                <div className="flex justify-between items-center text-orange-400 bg-orange-500/10 p-3 rounded-xl print:bg-slate-100 print:text-slate-900 print:rounded-none">
                  <span className="text-sm font-semibold uppercase">Modal / Porsi (HPP)</span>
                  <span className="text-lg font-bold">{formatIDR(totals.perPortion)}</span>
                </div>
              </div>

              {/* Pricing Logic - Slider Hidden on Print */}
              <div className="bg-slate-800 p-4 rounded-2xl mb-6 print:bg-white print:p-0 print:mb-4">
                <div className="flex justify-between items-center mb-3">
                  <label className="text-xs font-bold uppercase text-slate-400 flex items-center gap-1 print:text-slate-500">
                    <Percent size={14} /> Target Margin Laba
                  </label>
                  <span className="text-orange-400 font-bold print:text-slate-900">{targetMargin}%</span>
                </div>
                <input 
                  type="range" 
                  min="5" 
                  max="80" 
                  step="5"
                  value={targetMargin}
                  onChange={(e) => setTargetMargin(parseInt(e.target.value))}
                  className="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-orange-500 print:hidden"
                />
              </div>

              <div className="space-y-4">
                <div className="text-center p-4 bg-white/5 border border-white/10 rounded-2xl print:bg-slate-900 print:text-white print:rounded-none">
                  <p className="text-xs text-slate-400 uppercase tracking-widest font-bold mb-1 print:text-slate-300">Rekomendasi Harga Jual</p>
                  <h3 className="text-3xl font-black text-white">{formatIDR(totals.recommended)}</h3>
                </div>
                
                <div className="flex items-center gap-2 text-xs text-emerald-400 bg-emerald-500/10 p-3 rounded-xl border border-emerald-500/20 print:text-slate-900 print:bg-emerald-50 print:border-emerald-200">
                  <Info size={16} />
                  <span>Estimasi laba bersih <b>{formatIDR(totals.profitPerPortion)}</b> per porsi.</span>
                </div>
              </div>
            </div>

            {/* Quick Tips - Hidden on Print */}
            <div className="bg-orange-50 p-6 rounded-2xl border border-orange-100 print:hidden">
              <h4 className="font-bold text-orange-800 mb-2 text-sm flex items-center gap-2">
                <Info size={16} /> Tips Pricing
              </h4>
              <ul className="text-xs text-orange-700 space-y-2 list-disc pl-4">
                <li><b>Food Cost</b> ideal biasanya berkisar antara 25% - 35% dari harga jual.</li>
                <li>Lakukan pembulatan harga ke atas (misal: Rp12.350 menjadi Rp12.500 atau Rp13.000).</li>
              </ul>
            </div>

          </div>
        </div>

        {/* Footer */}
        <footer className="mt-12 pt-8 border-t border-slate-200 text-center text-slate-400 text-sm print:mt-4 print:text-[10px]">
          <p>Â© {new Date().getFullYear()} Recipe Costing Assistant - Laporan ini dihasilkan secara otomatis untuk keperluan analisis UMKM.</p>
        </footer>
      </div>
    </div>
  );
};

export default App;